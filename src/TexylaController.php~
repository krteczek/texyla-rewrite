<?php
/**
 * Project: Texyla Rewrite Dream Team
 * File: /texyla-rewrite/src/TexylaController.php
 * Description: AJAX endpoint pro generování náhledu Texy! syntaxe
 */

declare(strict_types=1);

namespace Texyla;

require_once __DIR__ . '/../vendor/autoload.php';

header('Content-Type: text/html; charset=utf-8');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405); // Method Not Allowed
    exit;
}

// Získání dat z JSON těla
$input = file_get_contents('php://input');
$data = json_decode($input, true);

$texySource = $data['texy_source'] ?? '';
$context = $data['context'] ?? 'default';

if (empty($texySource)) {
    echo '';
    exit;
}

try {
    // Získání Texy! objektu pro daný kontext
    [$texyObject, ] = TexylaConfigFactory::getContextSetup($context);
    
    // Procesování a výstup
    echo $texyObject->process($texySource);
    
} catch (\Exception $e) {
    http_response_code(500);
    error_log('Texy! chyba v controlleru: ' . $e->getMessage());
    echo '<p style="color: red;">Chyba při generování náhledu.</p>';
}