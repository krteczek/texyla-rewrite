/**
 * Project: Texyla Rewrite Dream Team
 * File: /texyla-rewrite/assets/texyla.js
 * Description: Hlavn√≠ t≈ô√≠da Texyla editoru - vanilla JavaScript implementace
 * 
 * @author Dream Team (Petr & B√≥)
 * @license MIT
 * @version 1.0.0
 */

/**
 * Hlavn√≠ t≈ô√≠da Texyla editoru
 * 
 * Poskytuje WYSIWYM editor s Texy! syntax√≠, toolbar s tlaƒç√≠tky
 * a AJAX n√°hledem. Kompatibiln√≠ s vanilla JavaScript, ≈æ√°dn√© z√°vislosti.
 * 
 * @example
 * // Inicializace editoru
 * const editor = new TexylaVanilla(document.getElementById('editor1'), '/api/texyla/preview');
 */
class TexylaVanilla {
    /**
     * Vytvo≈ô√≠ novou instanci Texyla editoru
     * 
     * @param {HTMLElement} textareaElement DOM element textarea pro editaci
     * @param {string} previewUrl URL endpointu pro AJAX n√°hled
     * @throws {Error} Pokud nen√≠ p≈ôed√°n validn√≠ HTML element
     */
    constructor(textareaElement, previewUrl) {
        this._validateConstructorArguments(textareaElement, previewUrl);
        
        // Inicializace vlastnost√≠
        this._textarea = textareaElement;
        this._previewUrl = previewUrl;
        this._wrapper = null;
        this._toolbar = null;
        this._previewPanel = null;
        this._previewButton = null;
        this._markers = [];
        this._isInitialized = false;
        
        // Inicializace editoru
        this._initializeEditor();
        
        console.info(`TexylaVanilla initialized for element #${this._textarea.id || 'unnamed'}`);
    }
    
    // --- VALIDACE A INICIALIZACE ---
    
    /**
     * Validuje vstupn√≠ argumenty konstruktoru
     * 
     * @private
     * @param {HTMLElement} textareaElement DOM element
     * @param {string} previewUrl URL endpointu
     * @throws {Error} Pokud argumenty nejsou validn√≠
     */
    _validateConstructorArguments(textareaElement, previewUrl) {
        if (!(textareaElement instanceof HTMLElement)) {
            throw new Error('TexylaVanilla: Prvn√≠ argument mus√≠ b√Ωt HTML element');
        }
        
        if (textareaElement.tagName !== 'TEXTAREA') {
            console.warn('TexylaVanilla: Element nen√≠ textarea, ale bude pou≈æit jako textov√Ω editor');
        }
        
        if (typeof previewUrl !== 'string' || previewUrl.trim() === '') {
            throw new Error('TexylaVanilla: Druh√Ω argument mus√≠ b√Ωt URL string');
        }
    }
    
    /**
     * Inicializuje editor a v≈°echny jeho komponenty
     * 
     * @private
     */
    _initializeEditor() {
        try {
            this._wrapTextarea();
            this._findOrCreatePreviewPanel();
            this._loadButtonConfig();
            this._createToolbar();
            this._addEventListeners();
            this._isInitialized = true;
        } catch (error) {
            console.error('TexylaVanilla initialization failed:', error);
            this._showErrorState('Editor se nepoda≈ôilo inicializovat');
        }
    }
    
    /**
     * Zobraz√≠ chybov√Ω stav editoru
     * 
     * @private
     * @param {string} message Chybov√° zpr√°va
     */
    _showErrorState(message) {
        this._textarea.style.borderColor = '#dc2626';
        this._textarea.title = `Chyba: ${message}`;
        console.error('Texyla error state:', message);
    }
    
    // --- DOM MANIPULACE ---
    
    /**
     * Obal√≠ textareu wrapperem a p≈ôiprav√≠ strukturu pro editor
     * 
     * @private
     */
    _wrapTextarea() {
        // Vytvo≈ôen√≠ hlavn√≠ho wrapperu
        this._wrapper = document.createElement('div');
        this._wrapper.className = 'texyla';
        
        // Ulo≈æen√≠ p≈Øvodn√≠ pozice a vlo≈æen√≠ wrapperu
        const parent = this._textarea.parentNode;
        parent.insertBefore(this._wrapper, this._textarea);
        
        // Vytvo≈ôen√≠ containeru pro obsah (textarea + preview)
        this._contentContainer = document.createElement('div');
        this._contentContainer.className = 'texyla__content';
        
        // P≈ôesun textarey do containeru
        this._contentContainer.appendChild(this._textarea);
        this._wrapper.appendChild(this._contentContainer);
    }
    
    /**
     * Najde nebo vytvo≈ô√≠ panel pro n√°hled
     * 
     * @private
     */
    _findOrCreatePreviewPanel() {
        const textareaId = this._textarea.id;
        
        // Hled√°n√≠ existuj√≠c√≠ho panelu
        if (textareaId) {
            this._previewPanel = this._wrapper.querySelector(`.texyla__preview[data-for="${textareaId}"]`);
        }
        
        // Pokud panel neexistuje, vytvo≈ô√≠me nov√Ω
        if (!this._previewPanel) {
            this._previewPanel = document.createElement('div');
            this._previewPanel.className = 'texyla__preview';
            this._previewPanel.dataset.for = textareaId || '';
            
            // P≈ôid√°n√≠ panelu jako sourozence textarey
            this._contentContainer.appendChild(this._previewPanel);
        }
        
        // V√Ωchoz√≠ stav - skryt√Ω
        this._previewPanel.style.display = 'none';
    }
    
    /**
     * Naƒçte konfiguraci tlaƒç√≠tek z data atributu
     * 
     * @private
     */
    _loadButtonConfig() {
        const configJson = this._textarea.dataset.texylaConfig;
        
        if (!configJson) {
            console.warn('TexylaVanilla: Konfigurace tlaƒç√≠tek nebyla nalezena v data-texyla-config');
            this._markers = [];
            return;
        }
        
        try {
            this._markers = JSON.parse(configJson);
            
            if (!Array.isArray(this._markers)) {
                console.warn('TexylaVanilla: Konfigurace tlaƒç√≠tek nen√≠ pole, pou≈æije se pr√°zdn√©');
                this._markers = [];
            }
        } catch (error) {
            console.error('TexylaVanilla: Chyba p≈ôi parsov√°n√≠ konfigurace:', error);
            this._markers = [];
        }
    }
    
    /**
     * Vytvo≈ô√≠ toolbar s tlaƒç√≠tky
     * 
     * @private
     */
    _createToolbar() {
        this._toolbar = document.createElement('div');
        this._toolbar.className = 'texyla__toolbar';
        
        // P≈ôid√°n√≠ tlaƒç√≠tek pro markery
        this._addMarkerButtons();
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro n√°hled
        this._addPreviewButton();
        
        // Vlo≈æen√≠ toolbaru p≈ôed obsah
        this._wrapper.insertBefore(this._toolbar, this._contentContainer);
    }
    
    /**
     * P≈ôid√° tlaƒç√≠tka pro markery do toolbaru
     * 
     * @private
     */
    _addMarkerButtons() {
        this._markers.forEach((item, index) => {
            const button = this._createToolbarButton(
                item.label || `Btn${index}`,
                item.title || '',
                item.marker || '',
                'marker'
            );
            this._toolbar.appendChild(button);
        });
    }
    
    /**
     * P≈ôid√° tlaƒç√≠tko pro p≈ôep√≠n√°n√≠ n√°hledu
     * 
     * @private
     */
    _addPreviewButton() {
        this._previewButton = this._createToolbarButton(
            'üëÅÔ∏è N√°hled',
            'P≈ôepnout do re≈æimu n√°hledu',
            '',
            'toggle-preview'
        );
        this._previewButton.className += ' texyla__button--preview';
        this._toolbar.appendChild(this._previewButton);
    }
    
    /**
     * Vytvo≈ô√≠ tlaƒç√≠tko pro toolbar
     * 
     * @private
     * @param {string} text Text tlaƒç√≠tka
     * @param {string} title Tooltip tlaƒç√≠tka
     * @param {string} marker Marker pro vlo≈æen√≠ (nebo akce)
     * @param {string} type Typ tlaƒç√≠tka ('marker' nebo 'toggle-preview')
     * @returns {HTMLButtonElement} Vytvo≈ôen√© tlaƒç√≠tko
     */
    _createToolbarButton(text, title, marker, type) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'texyla__button';
        button.textContent = text;
        button.title = title;
        
        if (type === 'marker' && marker) {
            button.dataset.marker = marker;
        } else if (type === 'toggle-preview') {
            button.dataset.action = 'toggle-preview';
        }
        
        return button;
    }
    
    // --- EVENT HANDLING ---
    
    /**
     * P≈ôid√° event listenery pro interakci s editorem
     * 
     * @private
     */
    _addEventListeners() {
        this._toolbar.addEventListener('click', this._handleToolbarClick.bind(this));
        
        // Debounced update preview p≈ôi psan√≠ (voliteln√©)
        this._setupDebouncedPreview();
    }
    
    /**
     * Obsluhuje kliknut√≠ na toolbar
     * 
     * @private
     * @param {MouseEvent} event Klik event
     */
    _handleToolbarClick(event) {
        const target = event.target;
        
        if (!target.classList.contains('texyla__button')) {
            return;
        }
        
        event.preventDefault();
        
        const marker = target.dataset.marker;
        const action = target.dataset.action;
        
        if (marker) {
            this._insertMarker(marker);
        } else if (action === 'toggle-preview') {
            this._togglePreviewMode();
        }
    }
    
    /**
     * Nastav√≠ debounced update preview p≈ôi psan√≠ (voliteln√© funkce)
     * 
     * @private
     */
    _setupDebouncedPreview() {
        // Toto je voliteln√° funkcionalita pro budouc√≠ roz≈°√≠≈ôen√≠
        // M≈Ø≈æeme p≈ôidat auto-update preview p≈ôi psan√≠ s debouncing
    }
    
    // --- FUNKƒåNOST EDITORU ---
    
    /**
     * Vlo≈æ√≠ marker na pozici kurzoru nebo obal√≠ vybran√Ω text
     * 
     * @private
     * @param {string} marker Texy! marker (nap≈ô. '**', '*', '```')
     */
    _insertMarker(marker) {
        const textarea = this._textarea;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const selectedText = text.substring(start, end);
        
        // Urƒçen√≠ typu markeru (p√°rov√Ω vs nep√°rov√Ω)
        const isPairedMarker = ['**', '*', '`', '```'].includes(marker);
        
        let newText, newCursorPos;
        
        if (selectedText && isPairedMarker) {
            // Obalen√≠ vybran√©ho textu
            newText = text.substring(0, start) + 
                     marker + selectedText + marker + 
                     text.substring(end);
            newCursorPos = end + marker.length * 2;
        } else {
            // Vlo≈æen√≠ markeru na pozici kurzoru
            newText = text.substring(0, start) + marker + text.substring(start);
            newCursorPos = start + marker.length;
            
            // Pro p√°rov√© markery bez v√Ωbƒõru um√≠stit kurzor mezi nƒõ
            if (isPairedMarker) {
                newCursorPos = start + marker.length;
            }
        }
        
        // Aktualizace textu a pozice kurzoru
        textarea.value = newText;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();
        
        // Trigger change event pro p≈ô√≠padn√© listenery
        this._triggerChangeEvent();
        
        console.debug(`Texyla: Vlo≈æen marker "${marker}" na pozici ${start}:${end}`);
    }
    
    /**
     * Spust√≠ change event na textarea
     * 
     * @private
     */
    _triggerChangeEvent() {
        const event = new Event('input', { bubbles: true });
        this._textarea.dispatchEvent(event);
    }
    
    /**
     * P≈ôep√≠n√° mezi re≈æimem editace a n√°hledu
     * 
     * @private
     */
    _togglePreviewMode() {
        const isPreviewActive = this._previewPanel.style.display !== 'none';
        
        if (isPreviewActive) {
            this._switchToEditMode();
        } else {
            this._switchToPreviewMode();
        }
    }
    
    /**
     * P≈ôepne do re≈æimu editace
     * 
     * @private
     */
    _switchToEditMode() {
        this._previewPanel.style.display = 'none';
        this._textarea.style.display = 'block';
        this._previewButton.textContent = 'üëÅÔ∏è N√°hled';
        this._previewButton.title = 'P≈ôepnout do re≈æimu n√°hledu';
        this._previewButton.classList.remove('texyla__button--active');
        this._textarea.focus();
    }
    
    /**
     * P≈ôepne do re≈æimu n√°hledu
     * 
     * @private
     */
    _switchToPreviewMode() {
        this._textarea.style.display = 'none';
        this._previewPanel.style.display = 'block';
        this._previewButton.textContent = '‚úèÔ∏è Editovat';
        this._previewButton.title = 'P≈ôepnout zpƒõt do re≈æimu editace';
        this._previewButton.classList.add('texyla__button--active');
        this.updatePreview();
    }
    
    /**
     * Naƒçte n√°hled p≈ôes AJAX a zobraz√≠ ho
     * 
     * @async
     * @returns {Promise<void>}
     */
    async updatePreview() {
        // Kontrola, zda je panel viditeln√Ω
        if (!this._previewPanel || this._textarea.style.display !== 'none') {
            return;
        }
        
        const context = this._textarea.dataset.context || 'default';
        const sourceText = this._textarea.value;
        
        // Pokud je text pr√°zdn√Ω, zobraz√≠me pr√°zdn√Ω n√°hled
        if (!sourceText.trim()) {
            this._previewPanel.innerHTML = '<p class="texyla-empty-preview">≈Ω√°dn√Ω text k n√°hledu</p>';
            return;
        }
        
        // Nastaven√≠ loading stavu
        this._setPreviewLoading(true);
        
        try {
            const html = await this._fetchPreview(sourceText, context);
            this._previewPanel.innerHTML = html;
        } catch (error) {
            this._showPreviewError(error);
        } finally {
            this._setPreviewLoading(false);
        }
    }
    
    /**
     * Nastav√≠ loading stav pro n√°hled
     * 
     * @private
     * @param {boolean} isLoading Zda je naƒç√≠t√°n√≠ aktivn√≠
     */
    _setPreviewLoading(isLoading) {
        if (isLoading) {
            this._previewPanel.classList.add('texyla__preview--loading');
        } else {
            this._previewPanel.classList.remove('texyla__preview--loading');
        }
    }
    
    /**
     * Z√≠sk√° n√°hled z serveru p≈ôes AJAX
     * 
     * @private
     * @async
     * @param {string} sourceText Texy! syntaxe
     * @param {string} context Kontext zpracov√°n√≠
     * @returns {Promise<string>} HTML n√°hled
     * @throws {Error} Pokud AJAX request sel≈æe
     */
    async _fetchPreview(sourceText, context) {
        const response = await fetch(this._previewUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'text/html',
            },
            body: JSON.stringify({
                texy_source: sourceText,
                context: context
            })
        });
        
        if (!response.ok) {
            throw new Error(`Server odpovƒõdƒõl s chybou: ${response.status} ${response.statusText}`);
        }
        
        return await response.text();
    }
    
    /**
     * Zobraz√≠ chybu v n√°hledu
     * 
     * @private
     * @param {Error} error Zachycen√° chyba
     */
    _showPreviewError(error) {
        console.error('Texyla preview error:', error);
        
        this._previewPanel.innerHTML = `
            <div class="texyla__error">
                <p>‚ùå Nelze naƒç√≠st n√°hled</p>
                <small>${this._escapeHtml(error.message)}</small>
            </div>
        `;
    }
    
    /**
     * Escape HTML speci√°ln√≠ch znak≈Ø
     * 
     * @private
     * @param {string} text Text k escapov√°n√≠
     * @returns {string} Escapovan√Ω text
     */
    _escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // --- PUBLIC API ---
    
    /**
     * Vr√°t√≠ aktu√°ln√≠ obsah editoru
     * 
     * @returns {string} Text z textarey
     */
    getValue() {
        return this._textarea.value;
    }
    
    /**
     * Nastav√≠ obsah editoru
     * 
     * @param {string} value Nov√Ω text
     */
    setValue(value) {
        this._textarea.value = value || '';
        this._triggerChangeEvent();
    }
    
    /**
     * Zjist√≠, zda je editor v re≈æimu n√°hledu
     * 
     * @returns {boolean} True pokud je aktivn√≠ n√°hled
     */
    isPreviewActive() {
        return this._previewPanel.style.display !== 'none';